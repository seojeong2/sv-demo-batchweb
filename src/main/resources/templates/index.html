<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SC Batch WEB</title>

    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <link href="/css/dev.css" rel="stylesheet">
    <link href="/css/toastr.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script type="text/javascript" src="/js/toastr.min.js"></script>

</head>

</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/vue@3"></script>-->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>



<!-- toastr 초기화 -->


<div id="app">


    <div class="container">
        <div class="row">
            <div class="col">
                <div class="header">
                    <h1>화자분류 배치 테스트</h1>
                </div>
            </div>
        </div>
    </div>


    <div class="row-cols-lg-1">
        <div class="sub-header">
            <h3> 음성파일 업로드 필요(wav, zip 형태) </h3>
        </div>
    </div>

    <div class="row">
        <div class="col-4"></div>
        <div class="col-4 text-center d-flex align-items-center justify-content-center">
            <div class="input-group mb-3">
                <div class="custom-file">

                    <label class="custom-file-label" for="inputGroupFile02"></label>
                    <input type="file" class="custom-file-input" id="inputGroupFile02" accept=".wav, .zip" @change="handleFileChange">
                </div>
                <button type="button" @click="uploadFile" class="btn btn-primary">음성파일 업로드</button>
            </div>
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-primary" @click="handleClassifyButtonClick">분류요청</button>
        </div>



    </div>

    <div class="row">
        <div class="col-1"></div>
        <div class="col-6">
            <div class="mb-3">
                <label for="formFileMultiple" class="form-label">음성 파일 등록</label>
                <input class="form-control" type="file" id="formFileMultiple" multiple accept=".wav, .zip" >
            </div>
        </div>
        <div class="col-1"></div>
        <div class="col-2">
            <div class="mb-3 d-flex justify-content-center">
                <button type="button" class="btn btn-primary" style="width: 150px">음성파일 업로드</button>
            </div>
            <div class="mb-3 d-flex justify-content-center">
                <button type="button" class="btn btn-primary" style="width: 150px"> 분류 요청</button>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-1"></div>
        <div class="col-6">
            <div class="mb-3">
                <label for="formFileMultiple" class="form-label">정답지 등록</label>
                <input class="form-control" type="file" id="formFileMultiple2" multiple>
            </div>
        </div>
        <div class="col-1"></div>
        <div class="col-2">
            <div class="mb-3 d-flex justify-content-center">
                <button type="button" class="btn btn-primary" style="width: 150px">정답파일 업로드</button>
            </div>
            <div class="mb-3 d-flex justify-content-center">
                <button type="button" class="btn btn-primary" style="width: 150px">결과 비교</button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-9"><h3 style="margin: 20px"> 음성파일 업로드 결과</h3></div>
        <div class="col-3"> <h3 style="margin: 20px"> 분류 결과</h3></div>

    </div>
<!--    <div class="rows-cols-3">-->
<!--        <h3 style="margin: 20px"> 분류 결과</h3>-->
<!--    </div>-->

    <div class="row">
        <div class="col-9">
            <div style="margin: 10px">
                <div v-if="uploadResult">
                    <ul class="list-group">
                        <li class="list-group-item" v-for="(path, index) in uploadResult.wavPathList" :key="index"> {{ path }}</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-3">
            <div style="margin: 10px">
                <div v-if="results.length > 0">
                    <ul class="list-group">
                        <li class="list-group-item" v-for="(item, index) in results" :key="index" :style="{'background-color':item.message !== 'error' ? 'lightgray':''}"> {{ item.result }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
      new Vue({
          el:'#app',
          data: {
              message: "",
              selectedFile: null,
              response: "",
              uploadResult: [],

              classifyResult:"",
              error:"",
              results:[],

          },

          methods: {
              handleFileChange(event) {
                  this.selectedFile = event.target.files[0];
              },
              uploadFile() {
                  console.log("click upload button!");
                  const formData = new FormData();
                  formData.append('file',this.selectedFile);

                  //http://localhost:8080/file-upload
                  //http://43.202.10.41:8080
                  axios.post('/file-upload',formData)
                      .then(response=>{
                          //this.message = response.data;
                          toastr.success("파일 업로드 성공");
                          this.uploadResult = response.data;

                      })
                      .catch(error => {
                          toastr.error("파일 업로드 실패");
                          this.uploadResult = "Error";
                          console.log("error");
                      })
              },
              sendClassify() {
                  console.log("click classify button");
                  console.log("upload success result: " , this.uploadResult.wavPathList);

                  const wavPaths = this.uploadResult.wavPathList;

                  //http://localhost:8080/batch/classify
                  //http://43.202.10.41:8080
                  axios.post("http://localhost:8080/batch/classify", wavPaths)
                      .then(response => {
                          this.classifyResult = response.data;
                          console.log("classify result list: ", this.classifyResult);
                          this.error="";
                      })
                      .catch(error => {
                          this.classifyResult = "Error";
                          console.log("error");
                          this.error = "error";

                      })


                  //axios.post('http://localhost:8080/batch/classify',)

              },

              async handleClassifyButtonClick() {
                  console.log("handle classify button click!");

                  if (!this.selectedFile) {
                      toastr.error("파일을 선택하세요.");
                      return;
                  }

                  try{
                      for(const filePath of this.uploadResult.wavPathList) {
                          console.log("filePath: " + filePath);
                          const response = await this.sendApiRequest(filePath);
                          console.log("response: " , response);
                          this.handleApiResponse(filePath, response.data);
                      }

                  } catch (error) {
                      toastr.error("API 요청중 오류 발생");
                      console.error("API 요청중 오류 발생", error);
                  }
              },

              async sendApiRequest(filePath) {
                  const response = await axios.post('/batch/classify',null,{params:{filePath}});
                  return response;
              },

              handleApiResponse(filePath, data) {
                  // 응답 결과를 저장하고 화면에 표시
                  const message = data;
                  console.log("message.score: ", message.score);

                  const result = message.score;

                  // this.results.push({filePath, message});
                  this.results.push({filePath, result});
              },


          },

      })
</script>
</body>
</html>

